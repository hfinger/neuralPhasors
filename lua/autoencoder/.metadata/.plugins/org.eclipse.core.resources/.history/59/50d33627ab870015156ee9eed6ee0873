
function loadData(normalizeMean)
  
  train = torch.load('mnist.t7/train_32x32.t7', 'ascii')
  test = torch.load('mnist.t7/test_32x32.t7', 'ascii')
  
  train = train.data
  test = test.data

  traindata = torch.Tensor(train:size()[1],1,32,32)
  for i = 1,train:size()[1] do   
    traindata[i] = train[i]
  end
  traindata:div(traindata:std())
  
  testdata = torch.Tensor(test:size()[1],1,32,32)
  for i = 1,test:size()[1] do   
    testdata[i] = test[i]
  end
  testdata:div(testdata:std())
  
  if normalizeMean then
    traindata:add(-traindata:mean())
    traindata:add(-traindata:mean())
  end
  
  return traindata, testdata
end

function train(steps, batchsize, data, model, parameters, gradParameters, config, phase)
    
    for i = 1,steps,batchsize do
    
        local feval = function(x)
            if x ~= parameters then
                parameters:copy(x)
            end

            -- reset gradients
            gradParameters:zero()
            local f = 0 
            for j = 0,batchsize-1 do            
                local activity = data[i+j]
               -- local phase = torch.Tensor(1,32,32):zero()
                local phase = (torch.rand(1,32,32)*2*math.pi)-math.pi
                local input = {torch.cmul(activity,torch.cos(phase)),torch.cmul(activity,torch.sin(phase)) }
                for k = 1,30 do
                    input = {input[1],autoencoder:forward(input)[2]}
                end
                local target = input
                local output = autoencoder:forward(input)
                local err = criterion:forward(output,target) 
                local df_dw = criterion:backward(autoencoder.output,target)
                f = f+err
                autoencoder:backward(input,df_dw)
            end
            gradParameters:div(batchsize)
            f = f/batchsize
            return f, gradParameters
        end 
    
    optim.sgd(feval, parameters, config)

    declin1.bias = torch.Tensor(1):zero()
    declin1.gradBias = torch.Tensor(1):zero()
    declin2.bias = torch.Tensor(1):zero()
    declin2.gradBias = torch.Tensor(1):zero()
    enc.convBias = torch.Tensor(50):zero()
    enc.convGradBias = torch.Tensor(50):zero()

end 
end