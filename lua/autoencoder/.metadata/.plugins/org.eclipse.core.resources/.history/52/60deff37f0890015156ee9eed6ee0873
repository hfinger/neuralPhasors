require 'unsup';
require 'nn';
require 'gnuplot';
require 'Encoder';
require 'Decoder';
require 'nngraph';
require 'image';
require 'optim';
require 'functions'
require 'image'

--load Data
traindata, testdata = loadData{normalizeMean = false} 

n_hidden = 50
n_input = 32*32
batchsize = 128
config = {learningRate = 0.01,
         weightDecay = 5e-5,
         momentum = 0,
         learningRateDecay = 5e-7}
         
--initialize Encode
enc = nn.Encoder(1,50,7)
dec = nn.Decoder(50,1,7)


autoencoder = nn.Sequential()
autoencoder:add(enc)
autoencoder:add(dec)

--set Criterion 
criterion = nn.ParallelCriterion()

xcrit = nn.MSECriterion() --compare x_in and x_out
ycrit = nn.MSECriterion() --compare y_in and y_out

criterion:add(xcrit,0.5)
criterion:add(ycrit,0.5)

parameters, gradParameters = autoencoder:getParameters()

trainModel(100, 32, traindata, autoencoder, criterion, parameters, gradParameters, config, false)

activity = traindata[9001]
phases = torch.Tensor(10,32,32)
images = torch.Tensor(10,3,32,32)

for i = 1,10 do
        
    local phase = (torch.rand(1,32,32)*2*math.pi)---math.pi
    local inp = {torch.cmul(activity,torch.cos(phase)),torch.cmul(activity,torch.sin(phase))}

    local out = autoencoder:forward(inp)
    local phase_out = torch.atan2(out[2],out[1])
    
    for j = 1,100 do
        out = autoencoder:forward({torch.cmul(activity,torch.cos(phase_out)),torch.cmul(activity,torch.sin(phase_out))})
        phase_out = torch.atan2(out[2],out[1])
    end
    
    a_out = torch.sqrt( torch.pow(out[1],2) + torch.pow(out[2],2 ))


    hsv = torch.Tensor(3,32,32)
    hsv[1]:copy((phase_out+math.pi)/(2*math.pi))
    hsv[2] = torch.Tensor(32,32):fill(0.5)
    hsv[3] = torch.Tensor(32,32):fill(0.5)
    rgb = image.hsv2rgb(hsv)

    phases[i] = phase_out[1]
    images[i] = rgb
  
end

image.save('result.png', images[1])
local phase_diff  = torch.Tensor(5,32,32)
local j = 1
for i = 1,9,2 do
    phase_diff[j] = phases[i]-phases[i+1]
    phase_diff[j] = phase_diff[j] - (torch.floor(phase_diff[j]/(2*math.pi))*(2*math.pi))
    j = j+1

end

gnuplot.hist(phase_diff,100)




